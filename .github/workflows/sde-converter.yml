name: EVE SDE Converter

permissions:
  contents: write
  id-token: write

on:
  push:
    branches: [ master ]
  schedule:
    - cron: '30 11 * * *'  # Every day at 11:30 UTC
  workflow_dispatch:  # Allow manual trigger

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  convert:
    runs-on: ubuntu-latest

    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      GH_TOKEN: ${{ github.token }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup pnpm
      uses: pnpm/action-setup@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install

    - name: Install tsx
      run: pnpm add -g tsx

    - name: Check if release exists
      id: check_release
      run: |
        BUILD_NUMBER=$(tsx src/index.ts check-update 2>&1 | grep "Latest build number:" | awk '{print $4}')
        COMMIT_SHA=$(git rev-parse --short HEAD)
        TAG_NAME="sde-${BUILD_NUMBER}-${COMMIT_SHA}"
        if gh release view "$TAG_NAME" >/dev/null 2>&1; then
          echo "Release $TAG_NAME already exists. Skipping."
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "Release $TAG_NAME does not exist. Proceeding."
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
        fi

    - name: Get change summary
      if: steps.check_release.outputs.exists == 'false'
      id: change_summary
      run: |
        SUMMARY=$(tsx src/index.ts get-change-summary ${{ steps.check_release.outputs.build_number }} 2>&1)
        # Use EOF for multiline output
        echo "summary<<EOF" >> $GITHUB_OUTPUT
        echo "$SUMMARY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Run conversion
      if: steps.check_release.outputs.exists == 'false'
      run: tsx src/index.ts convert

    - name: Generate incremental dump
      if: steps.check_release.outputs.exists == 'false'
      run: tsx src/index.ts increment ${{ steps.check_release.outputs.build_number }}

    - name: Compress files
      if: steps.check_release.outputs.exists == 'false'
      run: |
        bzip2 output/sde.sql &
        bzip2 output/sde.sqlite &
        bzip2 output/sde-postgres.sql &
        bzip2 output/sde-incremental.sql &
        bzip2 output/sde-incremental-postgres.sql &
        wait

    - name: Create and upload release
      if: steps.check_release.outputs.exists == 'false'
      env:
        CHANGE_SUMMARY: ${{ steps.change_summary.outputs.summary }}
      run: |
        TAG="sde-${{ steps.check_release.outputs.build_number }}-${{ steps.check_release.outputs.commit_sha }}"
        TITLE="EVE SDE Build ${{ steps.check_release.outputs.build_number }} (Commit ${{ steps.check_release.outputs.commit_sha }})"
        
        # Create notes using a temp file to avoid shell interpretation
        NOTES_FILE=$(mktemp)
        cat > "$NOTES_FILE" << 'RELEASE_NOTES'
        Automated release for EVE SDE build ${{ steps.check_release.outputs.build_number }}
        
        Commit: ${{ steps.check_release.outputs.commit_sha }}
        
        ## Changes Summary
        
        RELEASE_NOTES
        
        echo "$CHANGE_SUMMARY" >> "$NOTES_FILE"
        
        cat >> "$NOTES_FILE" << 'RELEASE_NOTES'
        
        ## Generated Files
        
        - sde.sql.bz2 (Compressed MySQL dump)
        - sde.sqlite.bz2 (Compressed SQLite database)
        - sde-postgres.sql.bz2 (Compressed PostgreSQL dump)
        - sde-incremental.sql.bz2 (Incremental MySQL dump — changed rows only)
        - sde-incremental-postgres.sql.bz2 (Incremental PostgreSQL dump — changed rows only)
        RELEASE_NOTES
        
        gh release create "$TAG" --title "$TITLE" --notes-file "$NOTES_FILE" ./output/sde.sql.bz2 ./output/sde.sqlite.bz2 ./output/sde-postgres.sql.bz2 ./output/sde-incremental.sql.bz2 ./output/sde-incremental-postgres.sql.bz2
        rm "$NOTES_FILE"
    - name: Notify Discord
      if: steps.check_release.outputs.exists == 'false' && env.DISCORD_WEBHOOK != ''
      env:
        RELEASE_URL: https://github.com/${{ github.repository }}/releases/tag/sde-${{ steps.check_release.outputs.build_number }}-${{ steps.check_release.outputs.commit_sha }}
      run: |
        # 构造 Discord embed JSON 并 POST 到 webhook
        curl -s -H "Content-Type: application/json" \
          -d '{"content":"${{ env.RELEASE_URL }}"}' \
          "${{ env.DISCORD_WEBHOOK }}"
